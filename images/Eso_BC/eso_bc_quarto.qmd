---
title: "Esophagectomy Body Composition"
format: beamer
editor: visual
---

## Introduction

Despite advanced in minimally-invasive and anesthetic techniques, esophagectomy remains a substantial operation associated with both perioperative morbidity and mortality.

**Sarcopenia**, or loss of muscle mass, can occur in patients with weight loss due to GI obstruction. Loss of muscle mass is associated with perioperative complications and poor postoperative survival for GI cancer patients

**Myosteatosis**, or fatty infiltration of muscle tissue, occurs with advanced age and inactivity and is associated with adverse outcomes in cancer patients

## Muscle mass measurement by CT

Muscle mass and myosteasosis can be measured from CT scans obtained for routine medical care [@amini1671]. The abdominal wall muscle area at L3 is associated with skeletal muscle muscle mass [@mitsiopoulos115]

Sarcopenia has been shown to be associated with postoperative complications after GI cancer surgery [@simonsen58]

## CT-Derived Body Composition

::: {layout-ncol="2"}
```{r}
#![CT Scan L3 slice](000485275.png)
```
-   Red - Muscle
-   Green - Intramuscular Adipose
-   Yellow - Visceral Adipose
-   Teal - Subcutanteous adipose
:::

## Muscle Measures

-   Skeletal Muscle Index (SMI)
    -   cross-sectional muscle area (-29 to 150HU)/(height in m^2^))
-   Skeletal Muscle Density (SMD)
    -   Mean density of muscle in Hounsfield Units
-   Skeletal Muscle Gauge (SMG)
    -   Skeletal Muscle Index $\times$ Skeletal Muscle Density

## Skeletal Muscle Gauge Quartiles

-   Q1 = Bottom Quartile for SMG
-   Q234 = Top three Quartiles for SMG

## Composite Risk Score

Skeletal Muscle Gauge and Age used to generate risk groups

-   Q1 and Age \>75 (highest risk group)
-   Q1 and Age \<75
-   Q234 and Age \>75
-   Q234 and Age \<75 (lowest risk group)

## Esophagectomy Cohort

-   Esophagectomy between 1/1/2010 and 3/1/2023
-   Mid-esophagus, distal esophagus, GE junction, or esophagus NOS
-   Surgery at CMC or Wake Forest University

Excluded:

-   No staging scans available
-   Height information not available
-   Clinical information not available

## Outcomes and complications

-   Mortality at 90 days (*Mort_90DH*)


```{r, echo=F}
library(tidyverse)
library(reporttools)
library(gtsummary)

la_mie_cohort_path<-'../data_export/la_mie_cohort_231221.csv'# Path to CSV file
cohort_la_mie<-read_csv(la_mie_cohort_path,show_col_types = FALSE)%>%     # Read CSV file
  as.data.frame()%>%      
  droplevels.data.frame()%>%                # Remove unused factor levels
  mutate(curative = case_when(
    Rx %in% c('ChemoRT','ChemoRT+S') ~ 'Curative',
    TRUE ~ 'Non-curative'
  ))%>%
 mutate(curative = case_when(
    Rx %in% c('ChemoRT','ChemoRT+S') ~ 'Curative',
    TRUE ~ 'Non-curative'
  ))%>%
  mutate(smg_preop_corrected = case_when(
         sex=='F' ~ smg_preop/0.685,
         sex=='M' ~ smg_preop
  ))%>%
  mutate(sex01 = case_when(
      sex=='F' ~ 1,
      sex=='M' ~ 2
  ))%>%
  mutate(`Anastomotic Leak` = case_when(
    Aleak == 'Yes' ~ 'Yes',
    TRUE ~ 'No'
  ))%>%
  mutate(`Risk Group` = factor(case_when(
    risk_group_preop4 == "High SMG <75" ~ 1,
      risk_group_preop4 == "Lo SMG <75" ~ 2,
    risk_group_preop4 == "High SMG 75+" ~ 3,
    risk_group_preop4 == "Lo SMG 75+" ~ 4
  ),levels=c(1:4), labels = c("Normal Muscle <75","Low Muscle <75","Normal Muscle 75+","Low Muscle 75+")))%>%
  mutate(smg2_preop = relevel(as.factor(smg2preop), ref="Q234"))%>%
  mutate(`Muscle Group` = smg2preop)%>%
  rename(Race=race3)
```

```{r}
make_labels <- function(.data,...){
  
  temp_table<-addmargins(table(.data$Mort_90DH,.data$risk_group_preop4))
  temp_prop<-prop.table(table(.data$Mort_90DH,.data$risk_group_preop4))
  label_hi_young<- paste0("Normal Muscle\nAge<75\n",temp_table[[2,1]],"/",temp_table[[3,1]],"=",round(temp_table[[2,1]]/temp_table[[3,1]],3)*100,"%")
  label_low_young<- paste0("Low Muscle\nAge<75\n",temp_table[[2,3]],"/",temp_table[[3,3]],"=",round(temp_table[[2,3]]/temp_table[[3,3]],2)*100,"%")
  label_hi_old<- paste0("Normal Muscle\nAge75+\n",temp_table[[2,2]],"/",temp_table[[3,2]],"=",round(temp_table[[2,2]]/temp_table[[3,2]],2)*100,"%")
  label_low_old<- paste0("Low Muscle\nAge 75+\n",temp_table[[2,4]],"/",temp_table[[3,4]],"=",round(temp_table[[2,4]]/temp_table[[3,4]],2)*100,"%")
  return(c(label_hi_young,label_low_young,label_hi_old,label_low_old)) 
  
}
```

## Study Cohort

```{r, echo=F}
eso_cohort<-cohort_la_mie%>%
  filter(mie_cohort==1 | wfu_cohort==1)
eso_bc<-eso_cohort%>%
  filter(smg_preop>0)%>%
  droplevels.data.frame()
esoc<-eso_cohort%>%
  filter(mie_cohort==1)%>%
    filter(smg_preop>0)%>%
  droplevels.data.frame()
```

## Sex Distribution by Institution

```{r}

eso_bc%>%
  tbl_cross (row=sex, col=Hospital, percent="row")%>%
  add_p()%>%
  bold_labels()


```

## Race Distribution by Institution

```{r}

eso_bc%>%
  tbl_cross (row=race, col=Hospital, percent="row")%>%
  add_p()%>%
  bold_labels()


```

## Histology Distribution by Institution

```{r}

eso_bc%>%
  tbl_cross (row=Histo, col=Hospital, percent="row")%>%
  add_p()%>%
  bold_labels()


```

## Sarcopenia by Institution - Prado

```{r}

eso_bc%>%
  tbl_cross (row=sarco_prado_preop, col=Hospital, percent="row")%>%
  add_p()%>%
  bold_labels()#%>%
#  modify_caption("Prado Definition of Sarcopenia: SMI < 52.4 cm^2^/m^2^ for Men or < 38.5 cm^2^/m^2^ for Women")
```

## 90-Day Mortality after Esophagectomy

```{r}

eso_bc%>%
  #rename(`Risk Group` = risk_group_preop4)%>%
  rename(`90-day Mortality`=Mort_90DH)%>%
  tbl_cross (row=`Risk Group`, col=`90-day Mortality`, percent="row")%>%
  add_p()%>%
  bold_labels()
```

## Outcomes - CMC
```{r}
esoc%>%
  dplyr::select(Thoracotomy,Laparotomy,`Anastomotic Leak`,Pneumonia)%>%
  tbl_summary()
```


```{r}
lcip<-prop.table(table(esoc$Mort_90DH,esoc$risk_group_preop4),2)
lcip
```

```{r}
lci<-addmargins(table(esoc$Mort_90DH,esoc$risk_group_preop4))
lci
```

```{r}
df_lci2 <- data.frame(x = c("Q234 <75","Q1 <75", "Q234 >75",  "Q1 >75","R1","R2","R3"), 
     denom = c(lci[[3,3]],lci[[3,1]], lci[[3,4]], lci[[3,2]], lci[[3,1]]+ lci[[3,4]]+lci[[3,2]] ,lci[[3,4]]+lci[[3,2]] , lci[[3,2]]), 
     height = c(100, 100, 100, 100,100,100,100),
     lower=c(lcip[[2,3]]*100,lcip[[2,1]]*100, lcip[[2,4]]*100,  lcip[[2,2]]*100, ((lci[[2,3]]+lci[[2,2]]+lci[[2,4]])/(lci[[3,3]]+ lci[[3,2]]+lci[[3,4]]))*100 , ((lci[[2,2]]+lci[[2,4]])/( lci[[3,2]]+lci[[3,4]]))*100  , ((lci[[2,2]])/(lci[[3,2]]))*100  ),

     lower2=c(0,0,0,0,0,0,0),
     numerator=  c(lci[[2,3]],lci[[2,2]], lci[[2,2]],  lci[[2,4]],lci[[2,3]]+lci[[2,2]]+lci[[2,4]],lci[[2,2]]+lci[[2,4]],lci[[2,2]] )  )

df_lci2
```



## 90-Day Mortality by Age and SMG

```{r}

cbPallette <- c("#F0E442", "#D55E00" ,"#009E73", "#E69F00" )

df<-df_lci2[c(1:4),]
df$w <- cumsum(df$denom)
df$wm <- df$w - df$denom
df$wt <- with(df, wm + (w - wm)/2)

library(ggplot2)
p <- ggplot(df, aes(ymin = 0)) +
  geom_rect(aes(xmin = wm, xmax = w,
     ymax = 100, ymin=0, fill = x)) +
  geom_rect(aes(xmin = wm, xmax = w,
     ymax = lower, ymin=0), fill = "black", alpha=0.2)+
    annotate("label", x=310, y=35, label= make_labels(esoc)[[2]],size=4)+
  annotate("label", x=380, y=50, label= make_labels(esoc)[[4]],size=4)+
  annotate("label", x=150, y=85, label= make_labels(esoc)[[1]],size=4)+
  annotate("label", x=350, y=75, label= make_labels(esoc)[[3]],size=4)+
  theme_bw() + theme(legend.position = "none") +
  xlim(0,400)+
  labs(x = "Number of Patients", y = "Mortality Percent")+
  scale_fill_manual(values=cbPallette)+
  ggtitle("90 Day Mortality after Esophagectomy")


p
```

## 
